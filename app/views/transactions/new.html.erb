<% content_for :head do %>
  <title><%= @item.title %></title>
    <!-- You can use open graph tags to customize link previews.
    Learn more: https://developers.facebook.com/docs/sharing/webmasters -->
  <meta property="og:url"           content="<%= request.original_url %>" />
  <meta property="og:type"          content="website" />
  <meta property="og:title"         content="<%= @item.title %>" />
  <meta property="og:description"   content="<%= @item.description %>" />

  <% if @pictures %>
    <meta property="og:image" content="<%= "https://adae.co#{@pictures.first.image.url(:med)}"  %>" />
  <% end %>
<% end %>
<%= stylesheet_link_tag "transactions" %>

<script>
  $(document).ready(function() {
    var total_price;
    <% if @item.listing_type != "sell" %>
      <% if params[:sell] == "true" %>
        $('#display-price')[0].innerHTML = "$" + markup_price(<%= @item.deposit %>);
        total_price = (markup_price(<%= @item.deposit %>));
        $('#total').val("$" + ((total_price * 1.029) + 0.30).toFixed(2));
        $('#stripe-fee')[0].innerHTML = "$" + ( (markup_price(<%= @item.deposit %>) * 0.029) + 0.30).toFixed(2);
        $('#price').val(total_price);
      <% end %>

      <% if current_user.stripe_customer_id.nil?  %>
        $('.stripe-button-el').click(function(event){

          if (!validateInteger($('#qty').val())){
            event.preventDefault();
          }
        });
      <% else %>
        $('.request-button').click(function(event){
          if (!validateInteger($('#qty').val())){
            event.preventDefault();
          }
        });
      <% end %>

    <% elsif @item.listing_type == "sell" %>
      $('#display-price')[0].innerHTML = "$" + markup_price(<%= @prices.first.amount %>);
      total_price = (markup_price(<%= @prices.first.amount %>));
      $('#total').val("$" + ((total_price * 1.029) + 0.30).toFixed(2));
      $('#stripe-fee')[0].innerHTML = "$" + ( (markup_price(<%= @prices.first.amount %>) * 0.029) + 0.30).toFixed(2);
      $('#price').val(total_price);
    <% end %>
  });

  var hash = {};

  <% @prices.each do |price| %>
      hash['<%= price.timeframe%>'] = <%= price.amount%>;
  <% end %>

  function qtyLength() {
    var lngth = $('select[name="transaction[length]"] option:selected').val();
    var qty = $('#qty').val();
    $('#times').val(qty);

    if (qty <= 1) {
      $('#length').val(lngth);
    }else if (qty > 1) {
      $('#length').val(lngth + 's');
    }else  {
      $('#length').val(lngth - 's');
    }
  }

  function updateQty() {
    update();
  }

  function validateInteger(quantity){
    if (quantity > 0 && (parseFloat(quantity) === parseInt(quantity, 10))){
      return true;
    }else {
      $('.toast').remove();


      toastr.options ={
        'timeOut': "5000",
        'extendedTimeOut': "2000",
        "positionClass": 'toast-top-center'
      };

      toastr.warning("Quantity must be in whole numbers");

      return false;
    }
  }

  function updateLength() {
    if ($('#qty').val() > 0 && $('select[name="transaction[length]"] option:selected').val() === "Hour"){
      $('#qty').prop('disabled', false);
      $('#qty').css("visibility", "visible");
      update();
    } else if ($('select[name="transaction[length]"] option:selected').val() === "Flat Rate") {
      $('#qty').val(1);
      $('#qty').prop('disabled', true);
      $('#qty').css("visibility", "hidden");
      update();
    }
  }

  //helper function for calculating adae fee, stripe fee, and grand total
  function update(){
    qtyLength();
    var length = $('#transaction_length').val();

    var amt = markup_price(hash[length]);
    $('#amt').val('$ ' + amt + ' x');

    var qty = $('#qty').val();
    var total = (amt * qty);

    if (validateInteger(qty)){
      // adae fee
      var fee = ((total * 0.029) + 0.30).toFixed(2);

      // sub total
      var pre_markup = total -  (qty * hash[length]);

      $('#subtotal').val('$' + total);
      $('#price').val(total);

      total = (parseFloat(total) + parseFloat(fee));

      //$('#markup-price')[0].innerHTML = "$" + pre_markup;
      $('#stripe-fee')[0].innerHTML = "$" + fee;
      $('#duration')[0].value = $('#qty').val() + "-" + $('#transaction_length').val();

      //decide wether to disable submit button or not depending on qty
      $('#transaction_total_price').val('$' + total);
    }
  }

  function markup_price(price) {
    var l1 = 1.1;
    var l2 = 1.08;
    var l3 = 1.06;
    var l4 = 1.04;
    var l5 = 1.02;
    var displayPrice = 0;

    if(price < 100) {
        displayPrice = Math.round(price*l1, 0);
    }else if(price >= 100 & price < 200) {
        displayPrice = Math.round(100*l1 + (price-100)*l2, -1);
    }else if(price >= 200 & price < 500) {
        displayPrice = Math.round(100*l1 + 100*l2 + (price-200)*l3, -1);
    }else if(price >= 500 & price < 1000) {
        displayPrice = Math.round(100*l1 + 100*l2 + 300*l3 + (price-500)*l4, -1);
    }else if(price >= 1000) {
        displayPrice = Math.round(100*l1 + 100*l2 + 300*l3 + 500*l4 + (price-1000)*l5, -1);
    }

    return displayPrice;
  }
</script>

<div class="payment-info">

  <div class="description">
    <h1 style="font-weight: 600; text-align: left; margin-bottom: 10px; margin-top: 1em;">Payment <a target="_blank" href="https://stripe.com/gallery"><%= image_tag "outline@2x.png", id: "stripe" %></a></h1>
    <div> You will only be charged if the owner accepts your request. However, he/she will not receive your money until the unique Transaction QR Code on his/her phone is scanned by you via the Adae Scanner App when you two meet. </div></br>
      <div> All our transactions are processed securely through <a id="stripe-link" target="_blank" href="https://stripe.com/gallery">Stripe</a>. We accept:</br>
          <div id="payment-icons">
            <%= image_tag "Visa-dark.png", class: "payment-logos" %>
            <%= image_tag "MasterCard-dark.png", class: "payment-logos" %>
            <%= image_tag "AmericanExpress-dark.png", class: "payment-logos" %>
            <%= image_tag "Stripe-dark.png", class: "payment-logos" %>
          </div>
      </div>
  </div>
  <div class="divider"></div>

  <script>
    window.fbAsyncInit = function() {

    };

    (function(d, s, id){
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5&appId=896455457041729";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    function share_prompt(){
      FB.ui(
        {
          method: 'feed',
          name: "<%= @item.title %>",
          link: "<%= request.original_url %>",
          picture: "<%= "https://adae.co#{@pictures.first.image.url(:med)}"  %>",
          caption: 'Reference Documentation',
          description: "<%= @item.description %>",
          message: ''
        },
        function(response) {
          if (response && response.post_id) {
            alert('Post was published.');
            $.ajax({url: "/discount", type: "POST", data: {item_id: "<%= @item.id %>"},});
          } else {
            alert('Post was not published.');
          }
        }
      );
    }
  </script>




  </br>
  </br>

  <div class="receipt-info-and-pic">

    <div style="display: inline-block; vertical-align: top;">
      <%= image_tag(@item.photo_url, class:'item-pic') %>
      <div id="fb-share-section">
        <input class="share-button" type="button" onclick="share_prompt()" value="Share" />
        <span style="color: #4a4a4a; font-size: 15px;"> and get 5% Off! </span>
        <span>
          <span style="bottom: 1px;" class="wrapper">
            <%= image_tag "question-mark.png", size:"13x14"%>
            <div class="tooltip">Share this page before submitting your request, and get 5% off of the entire price! </div>
          </span>
        </span>
      </div>
    </div>

    <div class="price-details">
      <!-- If listing type sell OR request  to buy a lease item -->
      <% if @item.listing_type == "sell" || params[:sell] == "true"%>

        <div class="item-detail-price" style="height: 260px;">
          <div class="item-title"><%=@item.title %></div>
          <div class="division"></div>
          <% unless params[:sell] == "true" %>
            <p id="display-price" style="font-size: 30px; font-weight: 500; color: #4a4a4a;"></p>
          <% else %>
            <p id="display-price" style="font-size: 30px; font-weight: 500; color: #4a4a4a;"></p>
          <% end %>
          <div style="margin-left: 0px;" class="credit-fee">
            <a style="margin-left: 20px" target="_blank" href="https://stripe.com/ca/pricing">Stripe Processing Fee:</a>
            <span>
              <span class="wrapper">
                <%= image_tag "question-mark.png", size:"13x14"%>
                <div class="tooltip">Stripe charges a flat fee of 2.9% + ¢30 to use their payment services. </br> Have a balance on Adae? We will pay with your balance first & reduce the Stripe fee proportionally. </div>
              </span>
            </span>
            <label style="margin-left: 30px" id="stripe-fee"></label>
          </div>

          <div class="division" style=" width: 86%;"></div>

          <span class="finalp">Total</span>
          <% unless params[:sell] == "true" %>
            <input id="total" readonly="readonly" value=""></input>
          <% else %>
            <input id="total" readonly="readonly" value=""></input>
          <% end %>
        </div>
      <!-- If listing type lease -->
      <% elsif @item.listing_type == "lease" %>
        <div class="item-detail-price" style="height: 410px;">
          <div class="item-title"><%=@item.title %></div>
          <div class="division"></div>
          <p class="how-long">What would you like to purchase?</p>
            <%= form_for Transaction.new, html: {multipart: true}  do |f| %>
              <%@prices.each do |price| %>
                <input id="qty" name="quantity" min="1" max="30" type="number" onChange="updateQty()"></input>
                <input id="prod" name="product" readonly="true" value="<%= price.title %>"></input><br>
              <% end%>

              <div class="division"></div>
              <div class="item-detail-calc">
                  <input id="amt" class="amount" readonly="readonly" value=""></input>
                  <input id="times" readonly="readonly" value=""></input>
                  <input id="length" readonly="readonly" value=""></input>
                  <input id="subtotal" readonly="readonly" value=""></input>

                  <div class="credit-fee">
                    <a target="_blank" href="https://stripe.com/ca/pricing">Stripe Processing Fee:</a>
                    <span>
                      <span class="wrapper">
                        <%= image_tag "question-mark.png", size:"13x14"%>
                        <div class="tooltip">Stripe charges a flat fee of 2.9% + ¢30 to use their payment services. </br> Have a balance on Adae? We will pay with your balance first & reduce the Stripe fee proportionally.</div>
                      </span>
                    </span>
                    <label id="stripe-fee"></label>
                  </div>
                  <div class="division" style=" width: 86%;"></div>
                  <div style="font-size: 12px; margin:15px 10px 15px 21px; line-height: normal; color: #4a4a4a; width: 88%;">
                    <!-- Pay a rental fee to try the item, and if you like it you can buy the item for the Trust Fee price. Your rental fees will count towards the final sale price. -->
                  </div>
                  <span class="finalp">Total</span>
                  <%= f.text_field :total_price, :value => "",:readonly => true %>
              </div>
            <% end %>
        </div>
      <!-- If listing type rent -->
      <% elsif @item.listing_type == "rent"%>
        <div class="item-detail-price" style="height: 300px;">
          <div class="item-title"><%=@item.title %></div>
          <div class="division"></div>
          <p class="how-long">How long would you like to rent this?</p>
          <%= form_for Transaction.new, html: {multipart: true}  do |f| %>
            <input id="qty" name="quantity" min="1" max="30" type="number" onChange="updateQty()"></input>
            <span><%= f.select :length, @type_dropdown, {}, :onchange => "updateLength()"%></span>

            <div class="division"></div>
            <div class="item-detail-calc">
              <input id="amt" class="amount" readonly="readonly" value=""></input>
              <input id="times" readonly="readonly" value=""></input>
              <input id="length" readonly="readonly" value=""></input>
              <input id="subtotal" readonly="readonly" value=""></input>

              <% unless @item.deposit == 0 %>
                <input class="trust-fee"readonly="readonly" value="Trust Fee: $<%= @item.deposit %>"></input>
                <span>
                  <span style="top: 1.5px;"class="wrapper">
                    <%= image_tag "question-mark.png", size:"13x14"%>
                    <div class="tooltip">This ensures that the item is treated with care, and is returned on time. <b style="font-weight: 600">This amount will only be charged if you fail to return the item, damage it, or lose it.</b></div>
                  </span>
                </span>
              <% end %>
              <div class="credit-fee">
                <a target="_blank" href="https://stripe.com/ca/pricing">Stripe Processing Fee:</a>
                <span>
                  <span class="wrapper">
                    <%= image_tag "question-mark.png", size:"13x14"%>
                    <div class="tooltip">Stripe charges a flat fee of 2.9% + ¢30 to use their payment services. </br> Have a balance on Adae? We will pay with your balance first & reduce the Stripe fee proportionally.</div>
                  </span>
                </span>
                <label id="stripe-fee"></label>
              </div>
              <div class="division" style=" width: 85%;"></div>
              <span class="finalp">Total</span>
              <%= f.text_field :total_price, :value => "",:readonly => true %>
            </div>
          <% end %>
        </div>
      <!-- If listing type timeoffer -->
      <% else %>
        <div class="item-detail-price" style="height: 280px;">
          <div class="item-title"><%=@item.title %></div>
          <div class="division"></div>
          <p class="how-long" style="font-size: 12px;">How long would you like this service to last?</p>
          <%= form_for Transaction.new, html: {multipart: true}  do |f| %>
            <input id="qty" name="quantity" min="1" max="30" type="number" onChange="updateQty()"></input>
            <span><%= f.select :length, @type_dropdown, {}, :onchange => "updateLength()"%></span>
            <div class="division"></div>
            <div class="item-detail-calc" style="margin-bottom: 15px;">
              <input id="amt" class="amount" readonly="readonly" value=""></input>
              <input id="times" readonly="readonly" value=""></input>
              <input id="length" readonly="readonly" value=""></input>
              <input id="subtotal" readonly="readonly" value=""></input>
                <% unless @item.deposit == 0 %>
                  <input class="deposit" readonly="readonly" value="$<%= @item.deposit %>"></input>
                <% end %>
                <div style="margin-left: 0px;"class="credit-fee">
                  <a style="margin-left:20px;" target="_blank" href="https://stripe.com/ca/pricing">Stripe Processing Fee:</a>
                  <span>
                    <span class="wrapper">
                      <%= image_tag "question-mark.png", size:"13x14"%>
                      <div class="tooltip">Stripe charges a flat fee of 2.9% + ¢30 to use their payment services. </br> Have a balance on Adae? We will pay with your balance first & reduce the Stripe fee proportionally.</div>
                    </span>
                  </span>
                  <label style="margin-left: 34px" id="stripe-fee"></label>
                </div>
                <div class="division" style="width: 85%;"></div>

              <div class="finalp">Discount</div>

              <%= f.text_field :discount_price, :value => "",:readonly => true %>

              <span class="finalp">Total</span>
              <%= f.text_field :total_price, :value => "",:readonly => true %>
            </div>
            <% end %>
        </div>
      <% end %>

      <!-- Stripe transaction form OR transaction request submission -->
      <center style="margin-bottom: 3em;">
        <% if current_user.stripe_customer_id.nil? %>
          <%= form_tag transactions_stripe_path do%>
            <script src="https://checkout.stripe.com/checkout.js" class="stripe-button"
              data-key=<%= Rails.application.secrets.publishable_key %>
              data-email=<%= current_user.email %>
              data-description="Send Request to <%= @item.user.name %>"
              data-image= "<%= asset_path 'adae_logo.png'%>"
              data-label="Add My Card"
              data-billingAddress="true">
            </script>

            <%= hidden_field_tag 'item_id', @item.id %>
            <%= hidden_field_tag 'price' %>
            <%= hidden_field_tag 'duration' %>
            <%= hidden_field_tag 'discount_used', 'false' %>
         <% end %>
        <% else %>
          <%= form_tag transactions_stripe_path do%>
            <%= hidden_field_tag 'item_id', @item.id %>
            <%= hidden_field_tag 'price' %>
            <%= hidden_field_tag 'duration' %>
            <%= hidden_field_tag 'discount_used', 'false' %>

            <%= submit_tag 'Send Request', class: "request-button"%>
          <% end %>
        <%end%>
      </center>
    </div>
  </div>

    <div>
      <div class="why-cc">
        Why should I add my credit/debit card?
        <div class="tooltip">
          <ul>
            <li>&#x2756; <b>Convenience & Security</b>: No need to deal with the hassle of counting cash or forgotten change. Adae safe keeps your money until you meet with the owner and pay electronically via the Adae Scanner App.</br></br></li>
            <li>&#x2756; When you add your card (you will NOT be charged), you will proceed to the chat page and discuss with the owner.</br><br></li>
            <li>&#x2756; Only when you have worked out the details, will the owner accept your request. This is when you are charged.</br><br></li>
            <li>&#x2756; The owner will NOT receive your money until you meet and pay with the Adae Scanner App. You can cancel and get a refund at anytime before you meet.</div></li>
          </ul>
      </div>
    </div>

</div>
